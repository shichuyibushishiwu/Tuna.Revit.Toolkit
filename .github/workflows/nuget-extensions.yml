name: tuna-extensions
on: 
 push: 
  branches: 
   - main 


jobs:
 nuget:
   strategy: 
    matrix: 
     version: [Rvt_16_Release, Rvt_17_Release, Rvt_18_Release, Rvt_19_Release, Rvt_20_Release, Rvt_21_Release, Rvt_22_Release, Rvt_23_Release, Rvt_24_Release, Rvt_25_Release, Rvt_26_Release]
   name: release nuget
   runs-on: windows-latest
   steps:
    - name: Setup .NET Core SDK
      uses: actions/setup-dotnet@v3.2.0
      with:
       dotnet-version: 8.0.x
       
    - name: checkout
      uses: actions/checkout@v4.0.0
    
    - name: Install dependencies
      run: dotnet restore src\Tuna.Revit.Extensions\Tuna.Revit.Extensions.csproj -p:Configuration=${{ matrix.version }}
      
    - name: Build
      run: dotnet build src\Tuna.Revit.Extensions\Tuna.Revit.Extensions.csproj --configuration ${{ matrix.version }}
      
    - name: Publish NuGet
      run: dotnet nuget push src\Tuna.Revit.Extensions\bin\${{ matrix.version }}\*.nupkg -k ${{secrets.NUGETKEY}} -s https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Unlist previous version
      shell: pwsh
      run: |
        $cfg = "${{ matrix.version }}"
        $year = ($cfg -replace '^Rvt_','').Split('_')[0]
        $map = @{
          '16'='2016.2'; '17'='2017.2'; '18'='2018.2'; '19'='2019.0';
          '20'='2020.0'; '21'='2021.0'; '22'='2022.0'; '23'='2023.0';
          '24'='2024.0'; '25'='2025.0'; '26'='2026.0'
        }
        if (-not $map.ContainsKey($year)) { Write-Host "Unknown year: $year"; exit 0 }
        $rvtVersion = $map[$year]
        $props = [xml](Get-Content "Directory.Build.props")
        $tunaVer = ($props.Project.PropertyGroup | Where-Object { $_.TunaVer } | Select-Object -ExpandProperty TunaVer)
        $major = [int]($tunaVer.ToString().Split('.')[0])
        $prevMajor = $major - 1
        $pkgId = "Tuna.Revit.Extensions"
        $index = "https://api.nuget.org/v3-flatcontainer/$pkgId/index.json"
        $versions = @()
        try {
          $resp = Invoke-RestMethod -Uri $index -Method GET -ErrorAction Stop
          $versions = $resp.versions
        } catch {
          Write-Host "Failed to fetch versions from nuget: $_"
          $versions = @()
        }
        $targets = $versions | Where-Object { $_ -like "$rvtVersion.$prevMajor" -or $_ -like "$rvtVersion.$prevMajor.*" }
        foreach ($v in $targets) {
          Write-Host "Unlisting $pkgId $v"
          dotnet nuget delete $pkgId $v -k "${{ secrets.NUGETKEY }}" -s https://api.nuget.org/v3/index.json --non-interactive || Write-Host "Skip: $pkgId $v"
        }

   

